// Prisma Schema for MeetVerse AI
// Database: SQLite (dev) / PostgreSQL (production)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ==========================================
// Authentication Models (NextAuth.js)
// ==========================================

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

// ==========================================
// Core Models
// ==========================================

model User {
  id            String    @id @default(cuid())
  email         String    @unique
  emailVerified DateTime? @map("email_verified")
  name          String?
  image         String?
  passwordHash  String?   @map("password_hash")

  // Subscription
  subscriptionTier String @default("FREE") @map("subscription_tier")

  // Organization
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])
  role           String        @default("MEMBER")

  // Preferences (JSON stored as string)
  preferences String @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  accounts            Account[]
  sessions            Session[]
  hostedMeetings      Meeting[]            @relation("MeetingHost")
  participations      MeetingParticipant[]
  assignedActionItems ActionItem[]         @relation("ActionItemAssignee")
  transcriptSegments  TranscriptSegment[]
  notifications       Notification[]
  pushDevices         PushDevice[]
  refreshTokens       RefreshToken[]

  @@index([organizationId])
  @@index([email])
  @@map("users")
}

model Organization {
  id   String @id @default(cuid())
  name String
  slug String @unique

  // Branding
  logoUrl String? @map("logo_url")

  // Settings (JSON stored as string)
  settings String @default("{}")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  users    User[]
  meetings Meeting[]

  @@map("organizations")
}

model Meeting {
  id     String @id @default(cuid())
  roomId String @unique @map("room_id")

  // Host
  hostId String @map("host_id")
  host   User   @relation("MeetingHost", fields: [hostId], references: [id])

  // Organization (optional for personal meetings)
  organizationId String?       @map("organization_id")
  organization   Organization? @relation(fields: [organizationId], references: [id])

  // Meeting Info
  title       String
  description String?

  // Scheduling
  scheduledStart DateTime? @map("scheduled_start")
  scheduledEnd   DateTime? @map("scheduled_end")
  actualStart    DateTime? @map("actual_start")
  actualEnd      DateTime? @map("actual_end")

  // Status: SCHEDULED, LIVE, ENDED, CANCELLED
  status String @default("SCHEDULED")

  // Settings (JSON stored as string)
  settings String @default("{}")

  // Recording
  recordingUrl String? @map("recording_url")

  // AI Generated Content
  aiSummary       String? @map("ai_summary")
  aiSummaryFormat String? @map("ai_summary_format")

  // Timestamps
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")
  deletedAt DateTime? @map("deleted_at")

  // Relations
  participants MeetingParticipant[]
  transcripts  TranscriptSegment[]
  actionItems  ActionItem[]
  highlights   MeetingHighlight[]
  chatMessages ChatMessage[]

  @@index([hostId])
  @@index([organizationId])
  @@index([status, scheduledStart])
  @@index([roomId])
  @@map("meetings")
}

model MeetingParticipant {
  id String @id @default(cuid())

  meetingId String  @map("meeting_id")
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  userId String? @map("user_id")
  user   User?   @relation(fields: [userId], references: [id])

  // For guests without accounts
  guestName  String? @map("guest_name")
  guestEmail String? @map("guest_email")

  // Role in meeting: HOST, CO_HOST, PARTICIPANT, GUEST
  role String @default("PARTICIPANT")

  // Timestamps
  joinedAt DateTime  @default(now()) @map("joined_at")
  leftAt   DateTime? @map("left_at")

  @@unique([meetingId, userId])
  @@index([meetingId])
  @@index([userId])
  @@map("meeting_participants")
}

model TranscriptSegment {
  id String @id @default(cuid())

  meetingId String  @map("meeting_id")
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Speaker
  speakerId   String? @map("speaker_id")
  speaker     User?   @relation(fields: [speakerId], references: [id])
  speakerName String? @map("speaker_name")

  // Content
  content String

  // Timing (milliseconds from meeting start)
  startTime Int @map("start_time")
  endTime   Int @map("end_time")

  // Transcription metadata
  confidence Float   @default(0.0)
  language   String  @default("en")
  isFinal    Boolean @default(true) @map("is_final")

  // Vector embedding for semantic search (stored as base64)
  embedding String?

  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  actionItems ActionItem[]

  @@index([meetingId])
  @@index([speakerId])
  @@index([meetingId, startTime])
  @@map("transcript_segments")
}

model ActionItem {
  id String @id @default(cuid())

  meetingId String  @map("meeting_id")
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Assignee (optional)
  assigneeId String? @map("assignee_id")
  assignee   User?   @relation("ActionItemAssignee", fields: [assigneeId], references: [id])

  // Content
  title       String
  description String?

  // Due date
  dueDate DateTime? @map("due_date")

  // Status: PENDING, IN_PROGRESS, COMPLETED, CANCELLED
  status String @default("PENDING")

  // Priority: LOW, MEDIUM, HIGH, URGENT
  priority String @default("MEDIUM")

  // Source (link to transcript)
  sourceTranscriptId String?            @map("source_transcript_id")
  sourceTranscript   TranscriptSegment? @relation(fields: [sourceTranscriptId], references: [id])

  // External integration
  externalTaskId String? @map("external_task_id")
  externalSystem String? @map("external_system")

  // AI metadata
  aiConfidence Float?  @map("ai_confidence")
  aiGenerated  Boolean @default(true) @map("ai_generated")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([meetingId])
  @@index([assigneeId])
  @@index([status])
  @@map("action_items")
}

model MeetingHighlight {
  id String @id @default(cuid())

  meetingId String  @map("meeting_id")
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Type: DECISION, KEY_MOMENT, QUOTE, QUESTION, TOPIC_CHANGE
  type String

  // Content
  content String
  quote   String?

  // Timing
  timestamp Int

  // Speaker (if applicable)
  speakerName String? @map("speaker_name")

  // AI metadata
  aiConfidence Float? @map("ai_confidence")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([meetingId])
  @@index([type])
  @@map("meeting_highlights")
}

model ChatMessage {
  id String @id @default(cuid())

  meetingId String  @map("meeting_id")
  meeting   Meeting @relation(fields: [meetingId], references: [id], onDelete: Cascade)

  // Sender
  senderId   String? @map("sender_id")
  senderName String  @map("sender_name")

  // Content
  content String

  // Type: TEXT, FILE, REACTION, SYSTEM
  type String @default("TEXT")

  // For file messages
  fileUrl  String? @map("file_url")
  fileName String? @map("file_name")
  fileSize Int?    @map("file_size")

  // Threading
  replyToId String?       @map("reply_to_id")
  replyTo   ChatMessage?  @relation("ChatReplies", fields: [replyToId], references: [id])
  replies   ChatMessage[] @relation("ChatReplies")

  // Private message (DM)
  isPrivate   Boolean @default(false) @map("is_private")
  recipientId String? @map("recipient_id")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([meetingId])
  @@index([senderId])
  @@map("chat_messages")
}

// ==========================================
// Mobile API Models
// ==========================================

model Notification {
  id String @id @default(cuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Content
  type  String // MEETING_STARTED, MEETING_ENDED, ACTION_ITEM, SUMMARY_READY, MENTION, SYSTEM
  title String
  body  String

  // Reference to related entity
  referenceType String? @map("reference_type") // meeting, action_item, etc
  referenceId   String? @map("reference_id")

  // Extra data
  metadata String @default("{}")

  // Read status
  isRead Boolean   @default(false) @map("is_read")
  readAt DateTime? @map("read_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId, isRead])
  @@index([userId, createdAt])
  @@map("notifications")
}

model PushDevice {
  id String @id @default(cuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  platform   String // ios, android
  token      String @unique
  deviceName String? @map("device_name")
  deviceId   String? @map("device_id")
  isActive   Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([userId])
  @@map("push_devices")
}

model RefreshToken {
  id String @id @default(cuid())

  userId String @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  token     String  @unique
  deviceId  String? @map("device_id")
  userAgent String? @map("user_agent")
  ipAddress String? @map("ip_address")

  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")

  createdAt DateTime @default(now()) @map("created_at")

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}
